<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../convert-mixin.html">

<polymer-element name="convert-code" attributes="">
  <template>
    <link rel="stylesheet" href="convert-code.css">

    <core-media-query query="min-width: 1260px" queryMatches="{{mediumScreen}}" on-core-media-change="{{viewResized}}"></core-media-query>
    <core-media-query query="max-width: 1060px" queryMatches="{{smallScreen}}" on-core-media-change="{{viewResized}}"></core-media-query>

        <paper-action-dialog id="help_dialog" heading="Help" transition="core-transition-center">
          <p>To Convert Code choose a file,<br> or paste 0.5 code on the left then click Convert button.<br><br>
            <br>To save converted code click Save button<br>
            or click <core-icon icon="content-copy"></core-icon> icon to copy to clipboard.<br>

            <br>To start over click Clear button
          </p>
      <paper-button affirmative autofocus>OK</paper-button>
    </paper-action-dialog>

    <paper-action-dialog id="copy_dialog" heading="Copy Converted Code" transition="core-transition-center">
      <p>Copy covnerted code by tapping control-c (Windows) or command-c (Mac)</p>
      <textarea id="copy_textarea" rows="20" cols="90" onclick="this.focus();this.select()"></textarea>
      <paper-button affirmative autofocus>OK</paper-button>
    </paper-action-dialog>

    <div horizontal layout fit>

      <core-header-panel main mode="standard" flex>

        <!-- Main Toolbar -->
        <core-toolbar class="{{pageToolbarClass}}" id="page_toolbar">
          Convert Code 0.5 to 0.9:
          <paper-icon-button icon="help" on-tap="{{toggleHelp}}"></paper-icon-button>
          <div id="file_name"></div>
          <div flex></div>
        </core-toolbar>

        <!-- Main Content -->
        <div class="page" fit>
          <div horizontal layout flex>

            <div id="convert_code_container" vertical layout flex>
              <div horizontal layout>
                <div class="left-title" horizontal layout center flex>
                  <div vertical layout flex>
                    <h3>Polymer 0.5  Code -
                      <span class="error-message"></span>
                    </h3>
                    <div class="branch-label"><span>your code</span>
                    </div>
                  </div>
                  <input type="file" id="file_input" on-change={{onFileChange}} class="file-input"/>
                  <paper-button id="convert_button" on-tap="{{onConvertCode}}" raised affirmative autofocus >
                     Convert
                  </paper-button>
                  <paper-button id="clear_button" on-tap="{{onClearCode}}" raised affirmative hidden>
                     Clear Code
                  </paper-button>
                </div>

                <div class="right-title" horizontal layout center flex>
                  <div vertical layout flex>
                    <h3>Polymer 0.9 Converted Code -
                      <span class="error-message">{{errorMessage8}}</span>
                    </h3>
                    <div id="right_branch_div" class="branch-label"><span>-- CONVERTED CODE --</span>
                    </div>
                  </div>
                  <paper-icon-button id="copy_converted_button" icon="content-copy" on-tap="{{copyConverted}}" hidden></paper-icon-button>
                  <paper-button id="save_button" on-tap="{{onSaveCode}}" raised affirmative autofocus hidden>
                     Save
                  </paper-button>
                </div>
              </div>
              <div horizontal layout class="code">
                <div flex class="left" id="code5">
                  <prism-js id="code5_prism" language="markup" escape="true"  linenumbers="true" hidden></prism-js>
                  <textArea id="your_code" placeholder="Paste your 0.5 code here"> </textarea>
                  <hr>
                  <div class="linkLeft" hidden?="{{hideLinks}}">
                  </div>
                </div>
                <div flex class="right" id="code8">
                  <prism-js id="code8_prism" language="markup" escape="true" linenumbers="true" theme="okaidia"></prism-js>
                  <div class="linkRight" hidden?="{{hideLinks}}">
                    TO DO:
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

      </core-header-panel>

    </div>

  </template>

  <script>
    (function () {
      Polymer(Polymer.mixin({

        pageToolbarClass: "page-toolbar",
        convertParam: false,
        owner: "polymer",
        leftBranch: "master",
        rightBranch: "0.8-preview",
        yourCode: "",
        fileName: "converted09.html",
        hideLinks: true,

        ready: function() {
          var elParam = this.getURLParameter('el');
          this.convertParam = this.getURLParameter('convert');
          this.$.file_name.innerHTML = "Choose file or paste code";
          this.$.your_code.value = "";
          console.log("convert-code ready", elParam, this.convertParam);
          if (elParam) {
            this.repoName = elParam;
          } else {
            // this.$.menu_panel.hidden = false;
          }
        },

        getURLParameter: function(name) {
          if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
            return decodeURIComponent(name[1]);
        },

        toggleHelp: function() {
          this.$.help_dialog.toggle();
        },

        onClearCode: function() {
          this.$.code5_prism.inputValue = " ";
          this.$.code8_prism.inputValue = " ";
          this.$.your_code.value = "";
          this.$.file_name.innerHTML = "Choose file or paste code";
          this.$.convert_button.hidden = false;
          this.$.clear_button.hidden = true;
          this.$.your_code.hidden = false;
          this.$.code5_prism.hidden = true;
          this.$.file_input.value = "";
          this.$.save_button.hidden = true;
        },

        onConvertCode: function() {
          this.convertCode1(this.$.your_code.value.split('\n'));
          this.$.code5_prism.inputValue = this.$.your_code.value;
          this.$.file_name.innerHTML = "paste code";
        },

        convertCode1: function(code) {
          this.$.your_code.hidden = true;
          this.$.code5_prism.hidden = false;
          this.$.clear_button.hidden = false;
          this.$.convert_button.hidden = true;
          this.$.save_button.hidden = false;
          this.convertCode2(code);
        },

        onFileChange: function(e) {
          console.log("onFileChange: ",e.target.files[0].name);
          var file = e.target.files[0];
          this.fileName = e.target.files[0].name;
          this.$.file_name.innerHTML = this.fileName;
          if (!file) {
            return;
          }
          var reader = new FileReader();
          reader.onload = function(e) {
            this.$.your_code.value = e.target.result;
            this.$.code5_prism.inputValue = this.$.your_code.value;
            // var contents = e.target.result.split(/[\r\n]+/g); // tolerate both Windows and Unix linebreaks;
            var contents = e.target.result.split('\n');
            this.convertCode1(contents);
          }.bind(this);
          reader.readAsText(file, "UTF-8");
        },

        displayContents: function(contents) {
          this.$.code5_prism.inputValue = contents;
        },

        onSaveCode: function() {
          console.log("onSaveCode: ");
          this.download(this.fileName, this.$.code8_prism.inputValue);
        },

      }, window.convertMixin));
    })();
  </script>
</polymer-element>
